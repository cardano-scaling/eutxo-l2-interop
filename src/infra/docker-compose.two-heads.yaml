# Two-heads topology (ID 0)

# Head A: alice, ida-1
# Head B: bob, ida-2

# Profiles:
# - (no profile): Hydra nodes in offline mode (default behavior)
# - offline: Explicit offline mode (same as no profile)
# - online-private: Hydra nodes connected to Cardano L1 node (local testnet)

x-hydra-node-base: &hydra-node-base
  image: ghcr.io/cardano-scaling/hydra-node:1.0.0
  networks:
    hydra_net:
  restart: always

volumes:
  cardano-node-2h-data:
  shared-config-2h:

services:
  # Cardano L1 Node (online-private profile only)
  cardano-node-2h:
    image: ghcr.io/intersectmbo/cardano-node:10.1.4
    platform: linux/amd64
    profiles:
      - online-private
    volumes:
      - cardano-node-2h-data:/data
      - shared-config-2h:/shared
      - .:/devnet
      - ./cardano-private-testnet-config/busybox:/busybox
      - ./cardano-private-testnet-config/cardano/entrypoint.sh:/entrypoint.sh
      - ./cardano-private-testnet-config/cardano/topology-pool1.json:/shared/node-1-topology.json
      - ./cardano-private-testnet-config/cardano/config-pool1.json:/shared/node-1-config.json.base
      - ./cardano-private-testnet-config/cardano/keys:/keys
      - ./cardano-private-testnet-config/cardano/reward_token_policy.script:/shared/reward_token_policy.script
      - ./cardano-private-testnet-config/genesis/byron/genesis.json:/shared/byron/genesis.json.base
      - ./cardano-private-testnet-config/genesis/shelley/genesis.json:/shared/shelley/genesis.json.base
      - ./cardano-private-testnet-config/genesis/shelley/genesis.alonzo.json:/shared/shelley/genesis.alonzo.json.base
      - ./cardano-private-testnet-config/genesis/shelley/genesis-utxo.addr:/shared/shelley/genesis-utxo.addr
      - ./cardano-private-testnet-config/genesis/shelley/genesis-utxo.skey:/shared/shelley/genesis-utxo.skey
      - ./cardano-private-testnet-config/genesis/shelley/genesis-utxo.vkey:/shared/shelley/genesis-utxo.vkey
      - ./cardano-private-testnet-config/genesis/conway/genesis.conway.json:/shared/conway/genesis.conway.json.base
    environment:
      - CARDANO_NODE_SOCKET_PATH=/data/node.socket
    entrypoint: ["/bin/bash", "/entrypoint.sh"]
    ports:
      - "32000:32000"
    networks:
      hydra_net:
        ipv4_address: 172.16.238.100
    healthcheck:
      test: ["CMD-SHELL", "test -f /shared/cardano.ready"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 60s

  # Publish Hydra reference scripts to L1 (online-private profile only)
  hydra-scripts-publisher:
    image: ghcr.io/cardano-scaling/hydra-node:1.0.0
    profiles:
      - online-private
    volumes:
      - shared-config-2h:/shared
      - .:/devnet
      - ./cardano-private-testnet-config/cardano/keys:/keys
      - cardano-node-2h-data:/data:ro
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Waiting for Cardano node to be ready..."
        while [ ! -f /shared/cardano.ready ]; do
          sleep 2
        done
        echo "Cardano node is ready. Waiting a bit more for transactions to settle..."
        sleep 10
        echo ""
        echo "=========================================="
        echo "Publishing Hydra reference scripts to L1"
        echo "=========================================="
        echo "Checking socket access..."
        if [ ! -S /data/node.socket ]; then
          echo "ERROR: Socket /data/node.socket not found or not accessible"
          exit 1
        fi
        echo "Socket found, publishing scripts..."
        set +e
        HYDRA_NODE_PATH=$$(find /nix/store -name "hydra-node" -type f 2>/dev/null | head -1)
        if [ -z "$$HYDRA_NODE_PATH" ]; then
          echo "ERROR: hydra-node binary not found"
          exit 1
        fi
        echo "Using hydra-node at: $$HYDRA_NODE_PATH"
        HYDRA_SCRIPTS_TX_ID=$$($$HYDRA_NODE_PATH publish-scripts \
          --testnet-magic 42 \
          --node-socket /data/node.socket \
          --cardano-signing-key /keys/funded_address.skey 2>&1)
        EXIT_CODE=$$?
        set -e
        if [ $$EXIT_CODE -eq 0 ] && [ -n "$$HYDRA_SCRIPTS_TX_ID" ] && [ "$$HYDRA_SCRIPTS_TX_ID" != "Usage:" ]; then
          echo "Hydra scripts published successfully!"
          echo "Transaction ID: $$HYDRA_SCRIPTS_TX_ID"
          echo "$$HYDRA_SCRIPTS_TX_ID" > /shared/hydra-scripts-tx-id.txt
          echo "Saved transaction ID to /shared/hydra-scripts-tx-id.txt"
          echo "You can now use --hydra-scripts-tx-id $$(cat /shared/hydra-scripts-tx-id.txt) with your Hydra nodes"
        else
          echo "ERROR: Failed to publish Hydra scripts (exit code: $$EXIT_CODE)"
          echo "Output: $$HYDRA_SCRIPTS_TX_ID"
          echo "You may need to publish them manually later."
          exit 1
        fi
    networks:
      hydra_net:
    depends_on:
      cardano-node-2h:
        condition: service_healthy

  # Head A: alice, ida-1 (offline mode - default, no profile needed)
  hydra-node-alice-2h:
    <<: *hydra-node-base
    volumes:
      - .:/devnet
      - ./persistence/alice-2h:/devnet/persistence/alice-2h
    ports:
      - "4011:4011"
      - "5011:5011"
    command:
      [
        "--node-id", "1",
        "--api-host", "0.0.0.0",
        "--listen", "172.16.238.11:5011",
        "--monitoring-port", "6011",
        "--api-port", "4011",
        "--peer", "172.16.238.19:5019",
        "--hydra-signing-key", "/devnet/credentials/alice/alice-hydra.sk",
        "--hydra-verification-key", "/devnet/credentials/ida/ida-hydra.vk",
        "--persistence-dir", "/devnet/persistence/alice-2h",
        "--offline-head-seed", "0000000000000000000000000000000000000000000000000000000000000001",
        "--ledger-protocol-parameters", "/devnet/protocol-parameters.json",
        "--initial-utxo", "/devnet/initial-utxos/two-heads/utxo-1.json"
      ]
    networks:
      hydra_net:
        ipv4_address: 172.16.238.11

  # Head A: alice, ida-1 (online-private mode)
  hydra-node-alice-2h-online:
    <<: *hydra-node-base
    profiles:
      - online-private
    volumes:
      - .:/devnet
      - ./persistence/alice-2h:/devnet/persistence/alice-2h
      - shared-config-2h:/shared
    ports:
      - "4011:4011"
      - "5011:5011"
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        HYDRA_SCRIPTS_TX_ID=$$(cat /shared/hydra-scripts-tx-id.txt | tr -d '\n\r')
        echo "Using Hydra scripts transaction ID: $$HYDRA_SCRIPTS_TX_ID"
        exec hydra-node \
          --node-id 1 \
          --api-host 0.0.0.0 \
          --listen 172.16.238.11:5011 \
          --monitoring-port 6011 \
          --api-port 4011 \
          --peer 172.16.238.19:5019 \
          --hydra-signing-key /devnet/credentials/alice/alice-hydra.sk \
          --hydra-verification-key /devnet/credentials/ida/ida-hydra.vk \
          --cardano-signing-key /devnet/credentials/alice/alice-funds.sk \
          --cardano-verification-key /devnet/credentials/ida/ida-funds.vk \
          --persistence-dir /devnet/persistence/alice-2h \
          --node-socket /shared/node.socket \
          --testnet-magic 42 \
          --hydra-scripts-tx-id "$$HYDRA_SCRIPTS_TX_ID" \
          --ledger-protocol-parameters /devnet/protocol-parameters.json
    networks:
      hydra_net:
        ipv4_address: 172.16.238.11
    depends_on:
      hydra-scripts-publisher:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 4011 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

  hydra-node-ida-1-2h:
    <<: *hydra-node-base
    volumes:
      - .:/devnet
      - ./persistence/ida-1-2h:/devnet/persistence/ida-1-2h
    ports:
      - "4019:4019"
      - "5019:5019"
    command:
      [
        "--node-id", "3",
        "--api-host", "0.0.0.0",
        "--listen", "172.16.238.19:5019",
        "--monitoring-port", "6019",
        "--api-port", "4019",
        "--peer", "172.16.238.11:5011",
        "--hydra-signing-key", "/devnet/credentials/ida/ida-hydra.sk",
        "--hydra-verification-key", "/devnet/credentials/alice/alice-hydra.vk",
        "--persistence-dir", "/devnet/persistence/ida-1-2h",
        "--offline-head-seed", "0000000000000000000000000000000000000000000000000000000000000001",
        "--ledger-protocol-parameters", "/devnet/protocol-parameters.json",
        "--initial-utxo", "/devnet/initial-utxos/two-heads/utxo-1.json"
      ]
    networks:
      hydra_net:
        ipv4_address: 172.16.238.19

  hydra-node-ida-1-2h-online:
    <<: *hydra-node-base
    profiles:
      - online-private
    volumes:
      - .:/devnet
      - ./persistence/ida-1-2h:/devnet/persistence/ida-1-2h
      - shared-config-2h:/shared
    ports:
      - "4019:4019"
      - "5019:5019"
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        HYDRA_SCRIPTS_TX_ID=$$(cat /shared/hydra-scripts-tx-id.txt | tr -d '\n\r')
        echo "Using Hydra scripts transaction ID: $$HYDRA_SCRIPTS_TX_ID"
        exec hydra-node \
          --node-id 3 \
          --api-host 0.0.0.0 \
          --listen 172.16.238.19:5019 \
          --monitoring-port 6019 \
          --api-port 4019 \
          --peer 172.16.238.11:5011 \
          --hydra-signing-key /devnet/credentials/ida/ida-hydra.sk \
          --hydra-verification-key /devnet/credentials/alice/alice-hydra.vk \
          --cardano-signing-key /devnet/credentials/ida/ida-funds.sk \
          --cardano-verification-key /devnet/credentials/alice/alice-funds.vk \
          --persistence-dir /devnet/persistence/ida-1-2h \
          --node-socket /shared/node.socket \
          --testnet-magic 42 \
          --hydra-scripts-tx-id "$$HYDRA_SCRIPTS_TX_ID" \
          --ledger-protocol-parameters /devnet/protocol-parameters.json
    networks:
      hydra_net:
        ipv4_address: 172.16.238.19
    depends_on:
      hydra-scripts-publisher:
        condition: service_completed_successfully
      hydra-node-alice-2h-online:
        condition: service_healthy

  # Head B: bob, ida-2 (offline mode - default, no profile needed)
  hydra-node-bob-2h:
    <<: *hydra-node-base
    volumes:
      - .:/devnet
      - ./persistence/bob-2h:/devnet/persistence/bob-2h
    ports:
      - "4022:4022"
      - "5022:5022"
    command:
      [
        "--node-id", "2",
        "--api-host", "0.0.0.0",
        "--listen", "172.16.238.22:5022",
        "--monitoring-port", "6022",
        "--api-port", "4022",
        "--peer", "172.16.238.29:5029",
        "--hydra-signing-key", "/devnet/credentials/bob/bob-hydra.sk",
        "--hydra-verification-key", "/devnet/credentials/ida/ida-hydra.vk",
        "--persistence-dir", "/devnet/persistence/bob-2h",
        "--offline-head-seed", "0000000000000000000000000000000000000000000000000000000000000002",
        "--ledger-protocol-parameters", "/devnet/protocol-parameters.json",
        "--initial-utxo", "/devnet/initial-utxos/two-heads/utxo-2.json"
      ]
    networks:
      hydra_net:
        ipv4_address: 172.16.238.22

  # Head B: bob, ida-2 (online-private mode)
  hydra-node-bob-2h-online:
    <<: *hydra-node-base
    profiles:
      - online-private
    volumes:
      - .:/devnet
      - ./persistence/bob-2h:/devnet/persistence/bob-2h
      - shared-config-2h:/shared
    ports:
      - "4022:4022"
      - "5022:5022"
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        HYDRA_SCRIPTS_TX_ID=$$(cat /shared/hydra-scripts-tx-id.txt | tr -d '\n\r')
        echo "Using Hydra scripts transaction ID: $$HYDRA_SCRIPTS_TX_ID"
        exec hydra-node \
          --node-id 2 \
          --api-host 0.0.0.0 \
          --listen 172.16.238.22:5022 \
          --monitoring-port 6022 \
          --api-port 4022 \
          --peer 172.16.238.29:5029 \
          --hydra-signing-key /devnet/credentials/bob/bob-hydra.sk \
          --hydra-verification-key /devnet/credentials/ida/ida-hydra.vk \
          --cardano-signing-key /devnet/credentials/bob/bob-funds.sk \
          --cardano-verification-key /devnet/credentials/ida/ida-funds.vk \
          --persistence-dir /devnet/persistence/bob-2h \
          --node-socket /shared/node.socket \
          --testnet-magic 42 \
          --hydra-scripts-tx-id "$$HYDRA_SCRIPTS_TX_ID" \
          --ledger-protocol-parameters /devnet/protocol-parameters.json
    networks:
      hydra_net:
        ipv4_address: 172.16.238.22
    depends_on:
      hydra-scripts-publisher:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 4022 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

  hydra-node-ida-2-2h:
    <<: *hydra-node-base
    volumes:
      - .:/devnet
      - ./persistence/ida-2-2h:/devnet/persistence/ida-2-2h
    ports:
      - "4029:4029"
      - "5029:5029"
    command:
      [
        "--node-id", "4",
        "--api-host", "0.0.0.0",
        "--listen", "172.16.238.29:5029",
        "--monitoring-port", "6029",
        "--peer", "172.16.238.22:5022",
        "--api-port", "4029",
        "--hydra-signing-key", "/devnet/credentials/ida/ida-hydra.sk",
        "--hydra-verification-key", "/devnet/credentials/bob/bob-hydra.vk",
        "--persistence-dir", "/devnet/persistence/ida-2-2h",
        "--offline-head-seed", "0000000000000000000000000000000000000000000000000000000000000002",
        "--ledger-protocol-parameters", "/devnet/protocol-parameters.json",
        "--initial-utxo", "/devnet/initial-utxos/two-heads/utxo-2.json"
      ]
    networks:
      hydra_net:
        ipv4_address: 172.16.238.29

  hydra-node-ida-2-2h-online:
    <<: *hydra-node-base
    profiles:
      - online-private
    volumes:
      - .:/devnet
      - ./persistence/ida-2-2h:/devnet/persistence/ida-2-2h
      - shared-config-2h:/shared
    ports:
      - "4029:4029"
      - "5029:5029"
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        HYDRA_SCRIPTS_TX_ID=$$(cat /shared/hydra-scripts-tx-id.txt | tr -d '\n\r')
        echo "Using Hydra scripts transaction ID: $$HYDRA_SCRIPTS_TX_ID"
        exec hydra-node \
          --node-id 4 \
          --api-host 0.0.0.0 \
          --listen 172.16.238.29:5029 \
          --monitoring-port 6029 \
          --peer 172.16.238.22:5022 \
          --api-port 4029 \
          --hydra-signing-key /devnet/credentials/ida/ida-hydra.sk \
          --hydra-verification-key /devnet/credentials/bob/bob-hydra.vk \
          --cardano-signing-key /devnet/credentials/ida/ida-funds.sk \
          --cardano-verification-key /devnet/credentials/bob/bob-funds.vk \
          --persistence-dir /devnet/persistence/ida-2-2h \
          --node-socket /shared/node.socket \
          --testnet-magic 42 \
          --hydra-scripts-tx-id "$$HYDRA_SCRIPTS_TX_ID" \
          --ledger-protocol-parameters /devnet/protocol-parameters.json
    networks:
      hydra_net:
        ipv4_address: 172.16.238.29
    depends_on:
      hydra-scripts-publisher:
        condition: service_completed_successfully
      hydra-node-bob-2h-online:
        condition: service_healthy

  startup-time-logger:
    image: alpine
    depends_on:
      - hydra-node-alice-2h
      - hydra-node-bob-2h
      - hydra-node-ida-1-2h
      - hydra-node-ida-2-2h
    command: sh -c "echo $$(( $$(date +%s) * 1000 )) > /shared/startup_time.txt && echo 'Timestamp written:' $$(cat /shared/startup_time.txt)"
    volumes:
      - .:/shared

  startup-time-logger-online:
    image: alpine
    profiles:
      - online-private
    depends_on:
      - hydra-node-alice-2h-online
      - hydra-node-bob-2h-online
      - hydra-node-ida-1-2h-online
      - hydra-node-ida-2-2h-online
    command: sh -c "echo $$(( $$(date +%s) * 1000 )) > /shared/startup_time.txt && echo 'Timestamp written:' $$(cat /shared/startup_time.txt)"
    volumes:
      - shared-config-2h:/shared

networks:
  hydra_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.16.238.0/24
          gateway: 172.16.238.1

